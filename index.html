<!DOCTYPE html>
<html>
    <head>
        <title>React Components</title>
        <link rel="stylesheet" href="style.css">
    </head>
    <body>
        <div id='react-container'></div>
        
        <script src="https://unpkg.com/react@15/dist/react.js"></script>
        <script src="https://unpkg.com/react-dom@15/dist/react-dom.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.38/browser.js"></script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/fetch/1.0.0/fetch.js"></script>
        <script src="https://npmcdn.com/react-draggable"></script>

        <script type="text/babel">
            class Note extends React.Component {
                constructor(props) {
                    super(props)
                    this.state = {editing: false}
                }

                componentWillMount() {
                    this.style = {
                        right: this.randomBetween(0, window.innerWidth - 150, 'px'),
                        top: this.randomBetween(0, window.innerHeight - 150, 'px')
                    }
                }

                componentDidUpdate() {
                    if (this.state.editing) {
                        this.refs.newText.focus()
                        this.refs.newText.select()
                    }
                }

                shouldComponentUpdate(nextProps, nextState) {
                    return this.props.children !== nextProps.children || this.state !== nextState
                }

                randomBetween(x, y, s) {
                    return (x + Math.ceil(Math.random() * (y-x))) + s
                }
                
                edit() {
                    this.setState({editing: true})
                }
                
                save() {
                    this.props.onChange(this.refs.newText.value, this.props.id)
                    this.setState({editing: false})
                }
                
                remove() {
                    this.props.onRemove(this.props.id)
                }
                
                renderForm() {
                    return (
                        <div className="note" 
                             style={this.style}>
                          <textarea ref="newText"
                                    defaultValue={this.props.children}>
                          </textarea>
                          <button onClick={ () => this.save() }>Save</button>
                        </div>
                    )
                }
                
                renderDisplay() {
                    return ( 
                        <div className="note"
                             style={this.style}>
                            <p>{this.props.children}</p>
                            <span>
                              <button onClick={ () => this.edit() }>Edit</button>
                              <button onClick={ () => this.remove() }>X</button>
                            </span>
                        </div>
                        )
                }
                
                render() {
                  return ( <ReactDraggable>
                           {(this.state.editing) ? this.renderForm()
                                              : this.renderDisplay()}
                           </ReactDraggable>
                    )

                }
            }

            class Board extends React.Component {
                constructor(props) {
                    super(props)
                    this.state = {
                        notes: [
                            {id: 1, note:'Call Jeffrey'},
                            {id: 2, note:'Study some VueJs'},
                            {id: 3, note:'Do some Karate'},
                        ]
                    }

                    this.update = this.update.bind(this)
                    this.eachNote = this.eachNote.bind(this)
                    this.add = this.add.bind(this)
                    this.nextId = this.nextId.bind(this)
                }

                componentWillMount() {
                    if (this.props.count) {
                        var url = `http://baconipsum.com/api/?type=all-meat&sentences=${this.props.count}`
                        fetch(url)
                              .then(results => results.json())
                              .then(array => array[0])
                              .then(text => text.split('. '))
                              .then(array => array.forEach(
                                    sentence => this.add(sentence)))
                              .catch(function(err) {
                                console.log("Didn't connect to the API", err)
                              })
                    }
                }

                nextId() {
                    this.uniqueId = this.uniqueId || 4
                    return this.uniqueId++
                }

                add(text) {
                    var notes = [
                        ...this.state.notes,
                        {
                            id: this.nextId(),
                            note: text
                        }
                    ]
                    this.setState({notes})
                }

                update(newText, id) {
                    var notes = this.state.notes.map(
                        note => (note.id !== id) ?
                           note : 
                            {
                                ...note, 
                                note: newText
                            }
                        )
                    this.setState({notes})
                }

                remove(id) {
                    var notes = this.state.notes.filter(note => note.id !== id)
                    this.setState({notes})
                }

                eachNote(note) {
                    return (<Note key={note.id}
                                  id={note.id}
                                  onChange={this.update}
                                  onRemove={ () => this.remove(note.id) }>
                              {note.note}
                            </Note>)
                }

                render () {
                    return (
                        <div className="board">
                            {this.state.notes.map(this.eachNote)}
                            <button onClick={ () => this.add('New Note') }>+</button>
                        </div>
                    )
                }
            }

            Board.propTypes = {
                count: function(props, propName) {
                    if  (typeof props[propName] !== "number") {
                        return new Error("The count must be a number!")
                    }

                    if  (props[propName] > 100) {
                        return new Error("The number of notes: " + props[propName] + " is ridiculous!")
                    }
                }
            }

            ReactDOM.render(<Board count={6}></Board>,
                document.getElementById('react-container'))
        </script>
    </body>
</html>




